# Adult Census 数据生成系统 - 完整流程图

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Adult V2 数据生成系统                              │
│                   (Self-Instruct + Discriminator-Guided)            │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
            ┌───────▼────────┐            ┌────────▼────────┐
            │  训练阶段        │            │   生成阶段        │
            │  (一次性)        │            │   (可重复)        │
            └───────┬────────┘            └────────┬────────┘
                    │                               │
                    │                               │
            [训练整体判别器]                   [使用判别器引导生成]
```

---

## 📋 阶段1: 训练整体判别器（一次性）

```
archive/adult.csv (32,561条真实数据)
        │
        ▼
┌─────────────────────────────────────────┐
│  adult_holistic_discriminator.py        │
│  训练整体判别器                           │
└─────────────────────────────────────────┘
        │
        ├─► 正样本: 10,000条真实数据
        └─► 负样本: 10,000条打乱数据（破坏真实分布）
        │
        ▼
┌─────────────────────────────────────────┐
│  模型训练                                 │
│  - GradientBoostingClassifier           │
│  - 学习真实 vs 生成的分布差异              │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│  模型评估                                 │
│  - 准确率: 96.2%                         │
│  - AUC: 0.990                           │
└─────────────────────────────────────────┘
        │
        ▼
adult_v2/trained_holistic_discriminator/
    ├─ holistic_discriminator.pkl      (模型)
    ├─ scaler.pkl                      (标准化器)
    ├─ encoders.pkl                    (编码器)
    └─ feature_names.pkl               (特征名)
```

**脚本**: `python train_holistic_discriminator_simple.py`

---

## 📋 阶段2: 数据生成流程（主流程）

### 2.1 初始化与数据加载

```
┌─────────────────────────────────────────┐
│  main_generator.py                      │
│  DataGenerator 初始化                    │
└─────────────────────────────────────────┘
        │
        ├─► 选择调度模式
        │   ├─ use_discriminator_guidance=False → DatasetWiseScheduler
        │   └─ use_discriminator_guidance=True  → HybridScheduler (判别器引导)
        │
        ├─► 加载整体判别器 (如果使用判别器引导)
        │   └─ holistic_discriminator.py → 加载训练好的模型
        │
        ▼
┌─────────────────────────────────────────┐
│  加载真实数据 (Benchmark基准)             │
│  load_real_samples()                    │
└─────────────────────────────────────────┘
        │
        └─► archive/adult.csv (全量32,561条)
                │
                ├─► Benchmark评估器: 保存所有数据用于统计对比
                ├─► 辅助模型训练: 学习统计特征（年龄、收入分布等）
                └─► 目标分布提取: 计算各字段的真实分布
```

---

### 2.2 生成循环（Self-Instruct迭代）

```
                开始生成
                   │
    ┌──────────────┴──────────────┐
    │     每批次生成 (Batch)        │
    └──────────────┬──────────────┘
                   │
    ┌──────────────▼──────────────┐
    │ ① 调度器决定生成条件          │
    └──────────────┬──────────────┘
                   │
         ┌─────────┴─────────┐
         │                   │
    ┌────▼─────┐      ┌─────▼──────────┐
    │ 普通调度器 │      │ 判别器引导调度器 │
    └────┬─────┘      └─────┬──────────┘
         │                   │
         │                   │
    ┌────▼───────────────────▼──────┐
    │  生成条件 (GenerationCondition) │
    │  - income: <=50K / >50K        │
    │  - age_range: young/middle/... │
    │  - education_level: low/med/hi │
    └────────────┬───────────────────┘
                 │
    ┌────────────▼──────────────┐
    │ ② 分解器创建子任务          │
    │    decomposer.py           │
    └────────────┬──────────────┘
                 │
         将条件分解为具体字段提示
                 │
    ┌────────────▼──────────────┐
    │ ③ Demonstration 管理       │
    │    demonstration_manager   │
    └────────────┬──────────────┘
                 │
         选择最相关的示例样本 (k-NN)
                 │
    ┌────────────▼──────────────┐
    │ ④ LLM 生成                │
    │    - 提示词构建             │
    │    - API调用 (批量10个)     │
    │    - 解析输出              │
    └────────────┬──────────────┘
                 │
           [10个新样本]
                 │
    ┌────────────▼──────────────┐
    │ ⑤ Curation (过滤与精炼)     │
    │    curation.py            │
    └────────────┬──────────────┘
                 │
         ├─► 格式检查
         ├─► 辅助模型修正
         ├─► 去重
         └─► 筛选高质量样本
                 │
           [精炼后的样本]
                 │
    ┌────────────▼──────────────┐
    │ ⑥ 判别器评分 (如开启)       │
    │    discriminator.score()   │
    └────────────┬──────────────┘
                 │
         每个样本获得真实度评分 [0,1]
                 │
    ┌────────────▼──────────────┐
    │ ⑦ 更新调度器               │
    │    scheduler.update()      │
    └────────────┬──────────────┘
                 │
         判别器引导: 记录样本+评分
         分析弱类别，调整下轮策略
                 │
    ┌────────────▼──────────────┐
    │  累积到生成池               │
    └────────────┬──────────────┘
                 │
           达到目标数量？
                 │
         ┌───────┴───────┐
         否               是
         │               │
         └──► 继续循环    └──► 进入评估阶段
```

---

### 2.3 调度策略对比

#### 🔵 普通调度器 (DatasetWiseScheduler)

```
┌─────────────────────────────────────┐
│  基于目标分布的静态调度               │
└─────────────────────────────────────┘
        │
        ▼
计算当前分布与目标分布的差距
        │
        ▼
选择差距最大的类别优先生成
        │
        └─► 保证分布平衡，但不考虑质量
```

**优点**: 简单、稳定、分布平衡
**缺点**: 可能生成低质量样本，无法自适应

---

#### 🟢 判别器引导调度器 (HybridScheduler) ⭐

```
┌─────────────────────────────────────┐
│  混合策略：分布 + 判别器反馈          │
└─────────────────────────────────────┘
        │
        ├─► 冷启动 (前50样本)
        │   └─► 使用目标分布策略
        │
        └─► 主动学习 (50样本后)
            │
            ├─► 80%: 目标分布策略 (探索)
            │   └─► 保证分布平衡
            │
            └─► 20%: 判别器引导策略 (利用)
                │
                ▼
        ┌───────────────────────────┐
        │ 分析最近100个样本的评分     │
        └───────────────────────────┘
                │
                ▼
        ┌───────────────────────────┐
        │ 按类别统计平均真实度        │
        │ - income: {<=50K, >50K}    │
        │ - age: {young, mid, senior}│
        │ - edu: {low, medium, high} │
        └───────────────────────────┘
                │
                ▼
        ┌───────────────────────────┐
        │ 找出真实度最低的组合        │
        └───────────────────────────┘
                │
                ▼
        优先生成该组合的样本
        (主动学习难样本)
```

**优点**: 
- ✅ 自适应：自动发现质量弱点
- ✅ 质量驱动：优先改进低分类别
- ✅ 平衡：仍保留分布探索

**实验结果**: 
- 平均真实度: **0.978**
- 高质量比例: **100%**

---

## 📋 阶段3: 评估流程

```
                生成完成
                   │
    ┌──────────────▼──────────────┐
    │  evaluation.py               │
    │  综合评估                     │
    └──────────────┬──────────────┘
                   │
         ┌─────────┴─────────┐
         │                   │
    ┌────▼─────────┐   ┌────▼────────┐
    │ Benchmark评估 │   │ Direct评估   │
    │ (vs真实数据)   │   │ (固有质量)   │
    └────┬─────────┘   └────┬────────┘
         │                   │
         │                   │
    ┌────▼────────────────────▼──────┐
    │  Benchmark评估详情              │
    │  ──────────────────────        │
    │  ① 分布相似度 (40%)             │
    │     - income分布                │
    │     - education分布             │
    │     - occupation分布            │
    │     - marital.status分布        │
    │     - 多维度KL散度/JS距离         │
    │                                 │
    │  ② 统计相似度 (30%)             │
    │     - 年龄: 均值/方差            │
    │     - 工时: 均值/方差            │
    │     - 相关性矩阵                 │
    │                                 │
    │  ③ 业务逻辑一致性 (30%)          │
    │     - 教育-收入关联              │
    │     - 工时-收入关联              │
    │     - 年龄-职业合理性             │
    └─────────────────────────────────┘
         │
         └─► Overall Similarity: 0.926
         
    ┌─────────────────────────────────┐
    │  Direct评估详情                   │
    │  ──────────────────────────      │
    │  ① Faithfulness 忠实度 (60%)     │
    │     ├─ Constraint Check         │
    │     │  └─ 格式/逻辑检查           │
    │     └─ Benchmark评估            │
    │        └─ 引用上面的结果          │
    │                                  │
    │  ② Diversity 多样性 (40%)        │
    │     ├─ 词汇多样性                 │
    │     │  └─ unique values统计      │
    │     ├─ 样本独特性                 │
    │     │  └─ 重复样本检测            │
    │     └─ 分布覆盖度                 │
    │        └─ 目标类别覆盖率          │
    └─────────────────────────────────┘
         │
         └─► Overall Score: 0.874
```

---

## 📁 文件结构与职责

```
Data_generater/
│
├── archive/
│   └── adult.csv                    # 原始真实数据 (32,561条)
│
├── adult_v2/                        # Adult专用模块
│   ├── adult_holistic_discriminator.py    # 整体判别器（训练+评分）
│   ├── trained_holistic_discriminator/    # 训练好的模型
│   │   ├── holistic_discriminator.pkl
│   │   ├── scaler.pkl
│   │   ├── encoders.pkl
│   │   └── feature_names.pkl
│   └── ... (其他Adult专用模块)
│
├── generator_modules/               # 通用生成框架
│   ├── main_generator.py           # 主生成器（协调所有模块）
│   ├── scheduler.py                # 普通调度器
│   ├── discriminator_guided_scheduler.py  # 判别器引导调度器 ⭐
│   ├── holistic_discriminator.py   # 判别器加载器
│   ├── decomposer.py               # 任务分解器
│   ├── demonstration_manager.py    # 示例管理器
│   ├── curation.py                 # 过滤与精炼
│   ├── evaluation.py               # 评估器 (Benchmark + Direct)
│   ├── task_spec.py                # 数据结构定义
│   └── auxiliary_model.py          # 辅助模型（统计检查）
│
├── train_holistic_discriminator_simple.py  # 训练判别器脚本
├── test_discriminator_only.py              # 测试判别器引导
├── test_discriminator_guided.py            # 对比测试（普通 vs 判别器）
└── test_with_benchmark.py                  # 完整测试（含评估）
```

---

## 🔄 核心数据流

```
Real Data (32,561) ──┬──► Train Discriminator ──► Model (0.962 acc)
                     │                                    │
                     └──► Benchmark Baseline             │
                              │                           │
                              ▼                           ▼
                    ┌─────────────────┐        ┌─────────────────┐
                    │  Generation     │◄───────│  Discriminator  │
                    │  (Self-Instruct)│        │  Guidance       │
                    └────────┬────────┘        └─────────────────┘
                             │                          ▲
                             ▼                          │
                    ┌─────────────────┐                 │
                    │   Curation      │                 │
                    │   (Filter)      │                 │
                    └────────┬────────┘                 │
                             │                          │
                             ├──► Generated Samples ────┘
                             │    (Score & Update)
                             ▼
                    ┌─────────────────┐
                    │   Evaluation    │
                    │ (Benchmark+Dir) │
                    └────────┬────────┘
                             │
                             ▼
                    Final Dataset + Report
```

---

## 🎯 使用示例

### 普通模式（基于分布）

```python
from generator_modules.main_generator import DataGenerator

generator = DataGenerator(
    verbose=True,
    use_discriminator_guidance=False  # 普通模式
)

generator.load_real_samples("archive/adult.csv", limit=None)
samples = generator.generate_simple(n_samples=100)
```

### 判别器引导模式（主动学习）⭐

```python
from generator_modules.main_generator import DataGenerator

generator = DataGenerator(
    verbose=True,
    use_discriminator_guidance=True,   # 判别器引导
    discriminator_model_dir="adult_v2/trained_holistic_discriminator"
)

generator.load_real_samples("archive/adult.csv", limit=None)
samples = generator.generate_simple(n_samples=100)
# → 平均真实度: 0.978, 高质量: 100%
```

---

## 📊 性能对比

| 指标 | 普通调度器 | 判别器引导 | 提升 |
|-----|-----------|-----------|------|
| 平均真实度 | 0.953 | **0.978** | +2.6% |
| 高质量比例 (>0.7) | 98.0% | **100%** | +2.0% |
| 样本独特性 | 61% | 75-85% (预期) | +14-24% |
| Benchmark相似度 | 0.926 | 0.926 | 持平 |
| Direct评分 | 0.874 | 0.880+ (预期) | +0.6%+ |

---

## 🚀 关键创新点

1. **整体判别器** - 学习真实分布特征，无需手动定义规则
2. **判别器引导调度** - 主动学习，优先生成低质量类别
3. **混合策略** - 平衡探索（分布）与利用（质量）
4. **全量Benchmark** - 使用完整真实数据（32,561条）作为基准
5. **模块化设计** - 清晰的职责分离，易于扩展

---

## 📝 下一步优化方向

1. **调整混合比例** - 探索不同的exploration_rate
2. **多目标优化** - 同时考虑真实度、多样性、覆盖度
3. **自适应学习率** - 根据生成进度动态调整策略
4. **增量学习** - 使用生成数据持续改进判别器
5. **分层调度** - 针对不同难度的类别使用不同策略
